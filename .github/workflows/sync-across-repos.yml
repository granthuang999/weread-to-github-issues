name: Sync Bookshelf Issue to Main Repo

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Sync Bookshelf to This Repo"]
    types:
      - completed

jobs:
  sync:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      issues: write

    steps:
      # 第1步：获取源仓库Issue的内容 (已修正)
      - name: Get source issue content
        id: get_source_issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.WEREAD_PAT }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const title = "我的微信读书书架 / My WeRead Bookshelf";

            const { data: issues } = await github.rest.search.issuesAndPullRequests({
              q: `repo:${owner}/${repo} is:issue is:open in:title "${title}"`,
            });
            
            if (issues.items.length === 0) {
              core.setFailed(`在 ${owner}/${repo} 中未找到标题为 "${title}" 的源Issue。`);
              return;
            }
            
            const issue = issues.items[0];
            console.log(`在 ${owner}/${repo} 中找到源Issue #${issue.number}。`);
            
            // 【关键修改】: 不要使用 return, 它会返回JSON字符串。
            // 使用 core.setOutput 来创建一个名为 'body' 的原始文本输出。
            core.setOutput('body', issue.body);
      
      # 第2步：在目标仓库中创建或更新Issue (已修正)
      - name: Create or Update Issue in Target Repo
        env:
          GH_TOKEN: ${{ secrets.WEREAD_PAT }}
          # 【关键修改】: 引用新的、正确的原始文本输出 'body'。
          # 此前是 'steps.get_source_issue.outputs.result'
          ISSUE_BODY: ${{ steps.get_source_issue.outputs.body }}
          ISSUE_TITLE: "我的微信读书书架 / My WeRead Bookshelf"
          TARGET_REPO: granthuang999/granthuang999.github.io
        run: |
          echo "$ISSUE_BODY" > body.md

          issue_number=$(gh issue list -R "$TARGET_REPO" --search "in:title \"$ISSUE_TITLE\"" --json number -q '.[0].number')

          if [ -n "$issue_number" ]; then
            echo "正在更新仓库 $TARGET_REPO 中的已有Issue #${issue_number}。"
            gh issue edit "$issue_number" -R "$TARGET_REPO" --body-file body.md
          else
            echo "正在仓库 $TARGET_REPO 中创建新的Issue。"
            gh issue create -R "$TARGET_REPO" --title "$ISSUE_TITLE" --body-file body.md --label "bookshelf,automated"
          fi
