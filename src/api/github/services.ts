/**
 * GitHub API æœåŠ¡æ¨¡å— (Markdown æ›´æ–°ç‰ˆ)
 */
import { Octokit } from "@octokit/rest";

// ä»ç¯å¢ƒå˜é‡ä¸­å®‰å…¨åœ°è·å–é…ç½®
const GITHUB_TOKEN = process.env.GITHUB_TOKEN || "";
const REPO_OWNER = process.env.GITHUB_REPO_OWNER || "";
const REPO_NAME = process.env.GITHUB_REPO_NAME || "";

// åˆå§‹åŒ–Octokitå®¢æˆ·ç«¯
const octokit = new Octokit({ auth: GITHUB_TOKEN });

const BOOKSHELF_ISSUE_TITLE = "æˆ‘çš„å¾®ä¿¡è¯»ä¹¦ä¹¦æ¶ / My WeRead Bookshelf";

/**
 * æŸ¥æ‰¾æˆ–åˆ›å»ºä¸€ä¸ªä¸“ç”¨äºå±•ç¤ºä¹¦æ¶çš„Issue
 */
export async function findOrCreateBookshelfIssue(): Promise<any | null> {
  console.log(`Searching for the dedicated bookshelf issue with title: "${BOOKSHELF_ISSUE_TITLE}"`);
  try {
    const { data: issues } = await octokit.search.issuesAndPullRequests({
      q: `repo:${REPO_OWNER}/${REPO_NAME} is:issue is:open in:title "${BOOKSHELF_ISSUE_TITLE}"`,
    });

    if (issues.items.length > 0) {
      const issue = issues.items[0];
      console.log(`Found existing bookshelf issue #${issue.number}.`);
      return issue;
    } else {
      console.log("Bookshelf issue not found. Creating a new one...");
      const { data: newIssue } = await octokit.issues.create({
        owner: REPO_OWNER,
        repo: REPO_NAME,
        title: BOOKSHELF_ISSUE_TITLE,
        body: "ğŸ“š This issue is automatically updated with my WeRead bookshelf.",
        labels: ["bookshelf", "automated"],
      });
      console.log(`Successfully created new bookshelf issue #${newIssue.number}.`);
      return newIssue;
    }
  } catch (error: any) {
    console.error("Error finding or creating the bookshelf issue:", error.message);
    return null;
  }
}

/**
 * ç”¨æœ€æ–°çš„ Markdown å†…å®¹æ›´æ–°ä¹¦æ¶Issue
 * @param issueNumber The number of the issue to update.
 * @param markdownContent The full Markdown content of the bookshelf.
 */
export async function updateBookshelfIssue(issueNumber: number, markdownContent: string): Promise<void> {
    console.log(`Updating issue #${issueNumber} with the latest bookshelf...`);
    try {
        // ã€å…³é”®ä¿®æ­£ã€‘ç›´æ¥ä½¿ç”¨ Markdown å†…å®¹ï¼Œå¹¶æ·»åŠ ä¸€ä¸ªç®€æ´çš„é¡µè„š
        const body = `
${markdownContent}

---
*Last updated: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}. Generated by WeRead Sync.*
`;
        await octokit.issues.update({
            owner: REPO_OWNER,
            repo: REPO_NAME,
            issue_number: issueNumber,
            body: body,
        });
        console.log(`âœ… Successfully updated issue #${issueNumber}.`);
    } catch (error: any) {
        console.error(`Error updating issue #${issueNumber}:`, error.message);
    }
}

